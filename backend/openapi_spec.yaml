openapi: 3.0.0
info:
  title: Paper Agent Backend API
  description: "README 的综合 API 文档，涵盖用户认证、PDF 管理、智能对话、笔记、高亮、翻译及路线图生成等功能。"
  version: 1.1.0
servers:
  - url: http://localhost:5000/api
    description: 本地开发服务器

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 访问令牌。通过 /auth/login 或 /auth/register 获取。

  schemas:
    # --- 通用响应 ---
    ErrorResponse:
      type: object
      required: [error]
      properties:
        code:
          type: string
          description: 机器可读的错误码
          example: "MISSING_FIELDS"
        error:
          type: string
          description: 人类可读的错误信息
          example: "Invalid file type"

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true

    # --- 用户认证 (Auth) ---
    RegisterRequest:
      type: object
      required: [username, email, password]
      properties:
        username: { type: string, example: "achyut" }
        email: { type: string, format: email, example: "achyut@example.com" }
        password: { type: string, minLength: 6, example: "123456" }

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "achyut@example.com" }
        password: { type: string, example: "123456" }

    RefreshRequest:
      type: object
      properties:
        refreshToken: { type: string, description: "注册或登录时返回的刷新令牌 (可选，优先由 HttpOnly Cookie 自动携带)" }

    AuthResponse:
      type: object
      properties:
        message: { type: string, example: "Login successful" }
        user:
          type: object
          properties:
            id: { type: string, format: uuid }
            username: { type: string }
            email: { type: string, format: email }
        accessToken: { type: string }

    RefreshResponse:
      type: object
      properties:
        accessToken: { type: string }

    MeResponse:
      type: object
      properties:
        user:
          type: object
          properties:
            id: { type: string, format: uuid }
            username: { type: string }
            email: { type: string, format: email }
            createdAt: { type: string, format: date-time }

    # --- PDF 管理 ---
    UploadResponse:
      type: object
      properties:
        pdfId: { type: string, description: "文件 Hash" }
        taskId: { type: string, description: "异步处理任务 ID" }
        status: { type: string, enum: [pending, processing, completed, failed] }
        pageCount: { type: integer }
        filename: { type: string }
        isNewUpload: { type: boolean }

    StatusResponse:
      type: object
      required: [status, currentPage, totalPages, paragraphs]
      properties:
        status: { type: string, enum: [pending, processing, completed, failed] }
        currentPage: { type: integer }
        totalPages: { type: integer }
        error: { type: string, nullable: true }
        paragraphs:
          type: array
          items:
            $ref: '#/components/schemas/Paragraph'

    InfoResponse:
      type: object
      required: [id, pageCount, metadata]
      properties:
        id: { type: string, description: "PDF Hash" }
        pageCount: { type: integer }
        metadata:
          type: object
          properties:
            title: { type: string }
            author: { type: string }
            subject: { type: string }
            keywords: { type: string }
        dimensions:
          type: array
          items:
            type: object
            properties:
              width: { type: number }
              height: { type: number }

    Paragraph:
      type: object
      required: [id, page, content, bbox]
      properties:
        id: { type: string, example: "pdf_chk_xxx_1_1" }
        page: { type: integer }
        index: { type: integer }
        bbox: { type: array, items: { type: number }, example: [100.0, 100.0, 200.0, 200.0] }
        content: { type: string }
        wordCount: { type: integer }

    # --- 智能对话 (Chat) ---
    Citation:
      type: object
      properties:
        source_type: { type: string, enum: [vector, graph] }
        id: { type: string }
        text: { type: string }
        score: { type: number }
        name: { type: string }

    MessageRequest:
      type: object
      required: [message, sessionId, pdfId]
      properties:
        message: { type: string }
        sessionId: { type: string, format: uuid }
        pdfId: { type: string }
        model: { type: string }
        apiKey: { type: string }
        apiBase: { type: string }
        history:
          type: array
          description: 可选，前端传入的历史覆盖（用于重发/编辑场景）。提供时跳过数据库历史查询。
          items:
            type: object
            required: [role, content]
            properties:
              role: { type: string, enum: [user, assistant] }
              content: { type: string }

    NewSessionResponse:
      type: object
      properties:
        sessionId: { type: string, format: uuid }
        title: { type: string }
        isNew: { type: boolean }
        messageCount: { type: integer }

    ChatResponse:
      type: object
      properties:
        response: { type: string }
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
        steps: { type: array, items: { type: string } }
        sessionId: { type: string, format: uuid }

    Session:
      type: object
      properties:
        id: { type: string, format: uuid }
        pdfId: { type: string }
        title: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    SessionListResponse:
      type: object
      properties:
        success: { type: boolean }
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/Session'
        total: { type: integer }

    Message:
      type: object
      properties:
        id: { type: integer }
        role: { type: string, enum: [user, assistant] }
        content: { type: string }
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
        timestamp: { type: string, format: date-time }

    SessionMessagesResponse:
      type: object
      properties:
        success: { type: boolean }
        sessionId: { type: string }
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        total: { type: integer }

    # --- 笔记 (Notes) ---
    Note:
      type: object
      properties:
        id: { type: integer }
        title: { type: string }
        content: { type: string }
        keywords: { type: array, items: { type: string } }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    CreateNoteRequest:
      type: object
      required: [pdfId]
      properties:
        pdfId: { type: string }
        title: { type: string }
        content: { type: string }
        keywords: { type: array, items: { type: string } }

    UpdateNoteRequest:
      type: object
      properties:
        title: { type: string }
        content: { type: string }
        keywords: { type: array, items: { type: string } }

    NoteListResponse:
      type: object
      properties:
        success: { type: boolean }
        notes:
          type: array
          items:
            $ref: '#/components/schemas/Note'
        total: { type: integer }

    NoteActionResponse:
      type: object
      required: [success, message]
      properties:
        success: { type: boolean }
        id: { type: integer, nullable: true }
        message: { type: string }

    # --- 高亮 (Highlight) ---
    Rect:
      type: object
      required: [x, y, width, height]
      properties:
        x: { type: number }
        y: { type: number }
        width: { type: number }
        height: { type: number }

    Highlight:
      type: object
      properties:
        id: { type: integer }
        page: { type: integer }
        rects:
          type: array
          items:
            $ref: '#/components/schemas/Rect'
        text: { type: string }
        color: { type: string }
        createdAt: { type: string, format: date-time }

    HighlightRequest:
      type: object
      required: [pdfId, page, rects, pageWidth, pageHeight, text, color]
      properties:
        pdfId: { type: string }
        page: { type: integer }
        rects:
          type: array
          items:
            $ref: '#/components/schemas/Rect'
        pageWidth: { type: number }
        pageHeight: { type: number }
        text: { type: string }
        color: { type: string, default: "#FFFF00" }

    HighlightListResponse:
      type: object
      properties:
        success: { type: boolean }
        highlights:
          type: array
          items:
            $ref: '#/components/schemas/Highlight'
        total: { type: integer }

    # --- 翻译 (Translate) ---
    TranslateParagraphRequest:
      type: object
      required: [pdfId, paragraphId]
      properties:
        pdfId: { type: string }
        paragraphId: { type: string }
        force: { type: boolean, default: false }

    TranslateTextRequest:
      type: object
      required: [text]
      properties:
        text: { type: string }
        pdfId: { type: string }
        contextParagraphs: { type: integer, default: 3 }

    PageTranslationsResponse:
      type: object
      properties:
        pdfId: { type: string }
        page: { type: integer }
        translations:
          type: object
          additionalProperties: { type: string }

    # --- 路线图 (Roadmap) ---
    Roadmap:
      type: object
      properties:
        nodes:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              type: { type: string }
              label: { type: string }
              data:
                type: object
                properties:
                  label: { type: string }
                  description: { type: string }
                  papers:
                    type: array
                    items:
                      type: object
                      properties:
                        title: { type: string }
                        link: { type: string }
                        year: { type: string }
              position:
                type: object
                properties:
                  x: { type: number }
                  y: { type: number }
        edges:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              source: { type: string }
              target: { type: string }
              label: { type: string }

    # --- 链接数据 (Link Data) ---
    LinkDataResponse:
      type: object
      properties:
        title: { type: string }
        url: { type: string }
        snippet: { type: string }
        published_date: { type: string }
        authors: { type: array, items: { type: string } }
        source: { type: string }
        valid: { type: integer, enum: [0, 1] }

security:
  - BearerAuth: []

paths:
  # ================= Auth =================
  /auth/register:
    post:
      tags: [Auth]
      summary: 用户注册
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
      responses:
        201:
          description: 注册成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthResponse' }
        400:
          description: 参数错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /auth/login:
    post:
      tags: [Auth]
      summary: 用户登录
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        200:
          description: 登录成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthResponse' }
        401:
          description: 认证失败
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /auth/refresh:
    post:
      tags: [Auth]
      summary: 刷新 Access Token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RefreshRequest' }
      responses:
        200:
          description: 刷新成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RefreshResponse' }

  /auth/me:
    get:
      tags: [Auth]
      summary: 获取当前用户信息
      responses:
        200:
          description: 用户信息
          content:
            application/json:
              schema: { $ref: '#/components/schemas/MeResponse' }

  # ================= PDF =================
  /pdf/upload:
    post:
      tags: [PDF]
      summary: 上传 PDF 文件
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file: { type: string, format: binary }
      responses:
        200:
          description: 上传成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UploadResponse' }

  /pdf/{pdf_id}/status:
    get:
      tags: [PDF]
      summary: 获取 PDF 处理状态
      parameters:
        - name: pdf_id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: 状态信息
          content:
            application/json:
              schema: { $ref: '#/components/schemas/StatusResponse' }

  /pdf/{pdf_id}/info:
    get:
      tags: [PDF]
      summary: 获取 PDF 元数据信息
      parameters:
        - name: pdf_id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: PDF 信息
          content:
            application/json:
              schema: { $ref: '#/components/schemas/InfoResponse' }

  /pdf/{pdf_id}/paragraphs:
    get:
      tags: [PDF]
      summary: 获取 PDF 段落列表
      parameters:
        - name: pdf_id
          in: path
          required: true
          schema: { type: string }
        - name: page
          in: query
          required: false
          schema: { type: integer }
      responses:
        200:
          description: 段落列表
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Paragraph' }

  /pdf/{pdf_id}/source:
    get:
      tags: [PDF]
      summary: 获取 PDF 源文件
      parameters:
        - name: pdf_id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: PDF 文件流
          content:
            application/pdf:
              schema: { type: string, format: binary }

  # ================= Chat =================
  /chatbox/new:
    post:
      tags: [Chat]
      summary: 分配新会话 ID
      responses:
        200:
          description: 新会话信息
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NewSessionResponse' }

  /chatbox/message:
    post:
      tags: [Chat]
      summary: 发送消息 (非流式)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MessageRequest' }
      responses:
        200:
          description: AI 回答
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ChatResponse' }

  /chatbox/simple-chat:
    post:
      tags: [Chat]
      summary: 简单对话 (直接全文上下文)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MessageRequest' }
      responses:
        200:
          description: AI 回答
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ChatResponse' }

  /chatbox/stream:
    post:
      tags: [Chat]
      summary: 流式对话 (SSE)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MessageRequest' }
      responses:
        200:
          description: 事件流
          content:
            text/event-stream:
              schema: { type: object }

  /chatbox/sessions:
    get:
      tags: [Chat]
      summary: 获取用户的会话列表
      parameters:
        - name: pdfId
          in: query
          required: false
          schema: { type: string }
      responses:
        200:
          description: 会话列表
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SessionListResponse' }

  /chatbox/session/{session_id}:
    delete:
      tags: [Chat]
      summary: 删除指定会话
      parameters:
        - name: session_id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        200:
          description: 删除结果
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessResponse' }

  /chatbox/session/{session_id}/messages:
    get:
      tags: [Chat]
      summary: 获取会话的历史消息
      parameters:
        - name: session_id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        200:
          description: 消息列表
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SessionMessagesResponse' }

  /chatbox/session/{session_id}/title:
    put:
      tags: [Chat]
      summary: 更新会话标题
      parameters:
        - name: session_id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                title: { type: string }
      responses:
        200:
          description: 更新成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessResponse' }

  # ================= Notes =================
  /notes:
    post:
      tags: [Notes]
      summary: 创建笔记
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateNoteRequest' }
      responses:
        200:
          description: 创建成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NoteActionResponse' }

  /notes/{pdf_id}:
    get:
      tags: [Notes]
      summary: 获取某 PDF 的所有笔记
      parameters:
        - name: pdf_id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: 笔记列表
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NoteListResponse' }

  /notes/{note_id}:
    put:
      tags: [Notes]
      summary: 更新笔记内容
      parameters:
        - name: note_id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateNoteRequest' }
      responses:
        200:
          description: 更新成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NoteActionResponse' }
    delete:
      tags: [Notes]
      summary: 删除笔记
      parameters:
        - name: note_id
          in: path
          required: true
          schema: { type: integer }
      responses:
        200:
          description: 删除成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NoteActionResponse' }

  # ================= Highlight =================
  /highlight:
    post:
      tags: [Highlight]
      summary: 创建高亮
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/HighlightRequest' }
      responses:
        200:
          description: 创建成功
          content:
            application/json:
              schema: { type: object, properties: { id: { type: integer }, success: { type: boolean } } }
    get:
      tags: [Highlight]
      summary: 获取 PDF 的高亮列表
      parameters:
        - name: pdfId
          in: query
          required: true
          schema: { type: string }
        - name: page
          in: query
          required: false
          schema: { type: integer }
      responses:
        200:
          description: 高亮列表
          content:
            application/json:
              schema: { $ref: '#/components/schemas/HighlightListResponse' }

  /highlight/{highlight_id}:
    put:
      tags: [Highlight]
      summary: 更新高亮颜色
      parameters:
        - name: highlight_id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                color: { type: string }
      responses:
        200:
          description: 更新成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessResponse' }
    delete:
      tags: [Highlight]
      summary: 删除高亮
      parameters:
        - name: highlight_id
          in: path
          required: true
          schema: { type: integer }
      responses:
        200:
          description: 删除成功
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SuccessResponse' }

  # ================= Translate =================
  /translate/paragraph:
    post:
      tags: [Translate]
      summary: 翻译指定段落
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TranslateParagraphRequest' }
      responses:
        200:
          description: 翻译结果
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  translation: { type: string }
                  paragraphId: { type: string }

  /translate/text:
    post:
      tags: [Translate]
      summary: 翻译选中文本 (带上下文)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TranslateTextRequest' }
      responses:
        200:
          description: 翻译结果
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  translatedText: { type: string }

  /translate/page/{pdf_id}/{page_number}:
    get:
      tags: [Translate]
      summary: 获取某页的所有已缓存翻译
      parameters:
        - name: pdf_id
          in: path
          required: true
          schema: { type: string }
        - name: page_number
          in: path
          required: true
          schema: { type: integer }
      responses:
        200:
          description: 翻译列表
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PageTranslationsResponse' }

  # ================= Link =================
  /link/data:
    post:
      tags: [Link]
      summary: 获取段落相关的外部引用数据 (Semantic Scholar)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pdfId, targetParagraphId]
              properties:
                pdfId: { type: string }
                targetParagraphId: { type: string }
      responses:
        200:
          description: 引用数据
          content:
            application/json:
              schema: { $ref: '#/components/schemas/LinkDataResponse' }

  # ================= Roadmap =================
  /roadmap:
    post:
      tags: [Roadmap]
      summary: 生成论文知识路线图
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pdfId]
              properties:
                pdfId: { type: string }
      responses:
        200:
          description: 路线图数据 (React Flow 格式)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Roadmap' }

  # ================= System =================
  /health:
    get:
      tags: [System]
      summary: 健康检查
      security: []
      responses:
        200:
          description: 系统正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: "ok" }
